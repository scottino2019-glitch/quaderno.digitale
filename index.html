<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quaderno Digitale</title>
<style>
  body { margin:0; font-family:sans-serif; }
  #toolbar { display:flex; flex-wrap:wrap; gap:5px; padding:5px; background:#333; color:white; }
  button { flex:1; padding:10px; font-size:14px; border:none; border-radius:5px; background:#555; color:white; }
  button.active { background:#28a745; }
  #viewer { position:relative; height:calc(100vh - 60px); overflow:auto; background:#eee; text-align:center; }
  canvas { margin:10px auto; display:block; background:white; }
  .annotation { position:absolute; background:rgba(255,255,0,0.8); padding:2px 4px; border:1px solid #888; font-size:16px; min-width:40px; }
</style>
</head>
<body>

<div id="toolbar">
  <input type="file" id="fileInput" accept="application/pdf">
  <button id="toggleTextBtn">Inserisci testo</button>
  <button id="undoBtn">Annulla</button>
  <button id="saveBtn">Salva</button>
  <button id="closeBtn">Chiudi</button>
</div>

<div id="viewer"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
/* ====== CONFIGURAZIONE FIREBASE ====== */
const firebaseConfig = {
  apiKey: "TUO_API_KEY",
  authDomain: "TUO_PROJECT.firebaseapp.com",
  projectId: "TUO_PROJECT",
  storageBucket: "TUO_PROJECT.appspot.com",
  messagingSenderId: "xxxx",
  appId: "xxxx"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

/* ====== VARIABILI GLOBALI ====== */
const viewer = document.getElementById('viewer');
const fileInput = document.getElementById('fileInput');
const toggleTextBtn = document.getElementById('toggleTextBtn');
const undoBtn = document.getElementById('undoBtn');
const saveBtn = document.getElementById('saveBtn');
const closeBtn = document.getElementById('closeBtn');

let pdfDoc = null;
let currentFile = null;
let annotations = [];
let insertMode = false;

/* ====== EVENTI ====== */
fileInput.addEventListener('change', async e => {
  const file = e.target.files[0];
  if(!file) return;
  currentFile = file;
  const arrayBuffer = await file.arrayBuffer();
  loadPDF(new Uint8Array(arrayBuffer));
});

toggleTextBtn.onclick = () => {
  insertMode = !insertMode;
  toggleTextBtn.classList.toggle('active', insertMode);
};

undoBtn.onclick = () => {
  annotations.pop();
  renderAnnotations();
};

closeBtn.onclick = () => {
  viewer.innerHTML = '';
  pdfDoc = null;
  annotations = [];
  currentFile = null;
  insertMode = false;
  toggleTextBtn.classList.remove('active');
};

saveBtn.onclick = async () => {
  if(!currentFile) return alert('Nessun PDF aperto!');
  
  // Upload PDF
  const pdfRef = storage.ref('pdfs/' + currentFile.name);
  await pdfRef.put(currentFile);
  
  // Upload annotazioni
  const annData = new Blob([JSON.stringify(annotations)], { type: 'application/json' });
  const annRef = storage.ref('pdfs/' + currentFile.name + '.annotations.json');
  await annRef.put(annData);
  
  alert('PDF e annotazioni salvati su Firebase!');
};

/* ====== FUNZIONI PDF ====== */
async function loadPDF(data) {
  pdfDoc = await pdfjsLib.getDocument({data}).promise;
  viewer.innerHTML = '';
  annotations = [];
  
  for(let i=1;i<=pdfDoc.numPages;i++){
    const page = await pdfDoc.getPage(i);
    const viewport = page.getViewport({scale:1.5});
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext('2d');
    await page.render({canvasContext: ctx, viewport}).promise;
    canvas.dataset.page = i;
    canvas.addEventListener('click', e => {
      if(!insertMode) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const text = prompt('Inserisci testo:');
      if(!text) return;
      annotations.push({ page: i, x, y, text });
      renderAnnotations();
    });
    viewer.appendChild(canvas);
  }
}

/* ====== RENDER ANNOTAZIONI ====== */
function renderAnnotations() {
  document.querySelectorAll('.annotation').forEach(a => a.remove());
  annotations.forEach(a => {
    const canvas = document.querySelector(`canvas[data-page="${a.page}"]`);
    if(!canvas) return;
    const noteDiv = document.createElement('div');
    noteDiv.className = 'annotation';
    noteDiv.style.left = a.x+'px';
    noteDiv.style.top = a.y+'px';
    noteDiv.textContent = a.text;
    canvas.parentElement.appendChild(noteDiv);
  });
}
</script>

</body>
</html>
