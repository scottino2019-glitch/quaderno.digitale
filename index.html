<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úèÔ∏è Quaderno Digitale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        /* --- STILI (uguali ai tuoi, accorciati per spazio) --- */
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); min-height: 100vh; padding:20px; }
        .container { max-width:1200px;margin:0 auto;background:white;border-radius:20px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.1);}
        .header { background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:25px;text-align:center;}
        .main-content { display:grid;grid-template-columns:320px 1fr;min-height:600px;}
        .sidebar { background:#f8f9fa;padding:25px;border-right:2px solid #e9ecef;}
        .tool-section { margin-bottom:25px;background:white;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,0.08);}
        .btn {width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;cursor:pointer;font-weight:600;}
        .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white;}
        .btn-success{background:linear-gradient(135deg,#56ab2f,#a8e6cf);color:white;}
        .btn-danger{background:linear-gradient(135deg,#ff416c,#ff4b2b);color:white;}
        .btn-warning{background:linear-gradient(135deg,#ff9a56,#ff6b6b);color:white;}
        .workspace { padding:25px;background:#f8f9fa;overflow-y:auto;}
        .pdf-viewer { background:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1);min-height:500px;display:flex;justify-content:center;align-items:center;}
        .pdf-canvas { border:2px solid #ccc;border-radius:10px;max-width:100%; }
        .text-list{max-height:200px;overflow-y:auto;border:1px solid #ddd;padding:10px;}
        .text-item{display:flex;justify-content:space-between;align-items:center;padding:6px;margin:4px 0;background:#fff;border:1px solid #eee;border-radius:6px;}
        .notification {position:fixed;top:20px;right:20px;padding:10px 15px;border-radius:8px;color:white;font-weight:600;z-index:1000;transform:translateX(400px);transition:.3s;}
        .notification.show{transform:translateX(0);}
        .notification.success{background:linear-gradient(135deg,#56ab2f,#a8e6cf);}
        .notification.error{background:linear-gradient(135deg,#ff416c,#ff4b2b);}
        .notification.info{background:linear-gradient(135deg,#4facfe,#00f2fe);}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>‚úèÔ∏è Quaderno Digitale</h1>
        <p>Aggiungi testo ai tuoi documenti PDF in modo semplice e veloce</p>
    </div>
    <div class="main-content">
        <div class="sidebar">
            <!-- Carica PDF -->
            <div class="tool-section">
                <h3>üìÅ Carica PDF</h3>
                <input type="file" id="fileInput" class="file-input" accept=".pdf" style="display:none;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üìÇ Seleziona PDF</button>
                <button class="btn btn-warning" onclick="closePDF()" id="closeBtn" style="display:none;">‚úñÔ∏è Chiudi PDF</button>
            </div>
            <!-- Aggiungi Testo -->
            <div class="tool-section">
                <h3>‚úèÔ∏è Aggiungi Testo</h3>
                <textarea id="textInput" placeholder="Scrivi qui..."></textarea>
                <label>Dimensione:</label>
                <input type="range" id="fontSize" min="8" max="72" value="16">
                <div id="fontSizeValue">16px</div>
                <label>Colore:</label>
                <input type="color" id="textColor" value="#000000">
                <label>Font:</label>
                <select id="fontFamily"><option>Helvetica</option><option>Times-Roman</option><option>Courier</option></select>
                <label>Allineamento:</label>
                <select id="textAlign"><option value="left">Sinistra</option><option value="center" selected>Centro</option><option value="right">Destra</option></select>
                <button class="btn btn-primary" onclick="enableTextMode()" id="addTextBtn" disabled>‚úèÔ∏è Inserisci</button>
            </div>
            <!-- Controlli -->
            <div class="tool-section">
                <h3>üîß Controlli</h3>
                <button class="btn btn-warning" onclick="undoLastText()">‚Ü∂ Annulla Ultimo</button>
            </div>
            <!-- Lista Testi -->
            <div class="tool-section">
                <h3>üìù Testi Aggiunti</h3>
                <div class="text-list" id="textList"><p style="text-align:center;color:#666;">Nessun testo</p></div>
            </div>
            <!-- Salvataggi -->
            <div class="tool-section">
                <h3>üíæ Salvataggi</h3>
                <input type="text" id="saveName" placeholder="Nome salvataggio">
                <button class="btn btn-success" onclick="salvaLavoro()">üíæ Salva</button>
                <button class="btn btn-danger" onclick="cancellaLavoro()">üóëÔ∏è Elimina</button>
                <select id="lavoriList" onchange="apriLavoro()"><option value="">-- Seleziona --</option></select>
            </div>
        </div>
        <div class="workspace">
            <div class="pdf-viewer" id="pdfViewer">
                <div class="empty-state"><h3>Carica un PDF per iniziare</h3></div>
            </div>
            <div class="page-controls" id="pageControls" style="display:none;">
                <button onclick="previousPage()" id="prevBtn">‚¨ÖÔ∏è Precedente</button>
                <span id="pageInfo">Pagina 1 di 1</span>
                <button onclick="nextPage()" id="nextBtn">Successiva ‚û°Ô∏è</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPDF=null,currentPage=1,totalPages=0,currentZoom=1,textElements=[],originalPDFData=null;

// eventi base
document.getElementById("fileInput").addEventListener("change",handleFileSelect);
document.getElementById("fontSize").addEventListener("input",e=>{document.getElementById("fontSizeValue").textContent=e.target.value+"px";});

// Carica PDF
async function handleFileSelect(e){
    const file=e.target.files[0]; if(!file)return;
    originalPDFData=await file.arrayBuffer();
    currentPDF=await pdfjsLib.getDocument(originalPDFData).promise;
    totalPages=currentPDF.numPages; currentPage=1; textElements=[];
    renderPage(currentPage);
    document.getElementById("pageControls").style.display="flex";
    document.getElementById("addTextBtn").disabled=false;
    document.getElementById("closeBtn").style.display="block";
    showNotification("PDF caricato!","success");
}
async function renderPage(num){
    if(!currentPDF)return;
    const page=await currentPDF.getPage(num);
    const viewport=page.getViewport({scale:currentZoom});
    const canvas=document.createElement("canvas"); canvas.id="pdfCanvas"; canvas.width=viewport.width; canvas.height=viewport.height;
    const ctx=canvas.getContext("2d"); await page.render({canvasContext:ctx,viewport}).promise;
    document.getElementById("pdfViewer").innerHTML=""; document.getElementById("pdfViewer").appendChild(canvas);
    applyTextElements(canvas);
}
function applyTextElements(canvas){
    const ctx=canvas.getContext("2d"); const pageTexts=textElements.filter(t=>t.page===currentPage);
    pageTexts.forEach(t=>{ctx.font=`${t.fontSize}px ${t.fontFamily}`;ctx.fillStyle=t.color;
        let x=t.x,y=t.y,w=ctx.measureText(t.text).width;
        if(t.textAlign==="center")x-=w/2;else if(t.textAlign==="right")x-=w;
        ctx.fillText(t.text,x,y);});
}
function enableTextMode(){
    const text=document.getElementById("textInput").value.trim(); if(!text){showNotification("Scrivi un testo!","error");return;}
    const canvas=document.getElementById("pdfCanvas");
    canvas.addEventListener("click",function handler(e){
        const rect=canvas.getBoundingClientRect(); const x=(e.clientX-rect.left); const y=(e.clientY-rect.top);
        textElements.push({id:Date.now(),page:currentPage,x,y,text,fontSize:parseInt(document.getElementById("fontSize").value),
            color:document.getElementById("textColor").value,fontFamily:document.getElementById("fontFamily").value,textAlign:document.getElementById("textAlign").value});
        renderPage(currentPage); updateTextList(); document.getElementById("textInput").value="";
        canvas.removeEventListener("click",handler);
    });
    showNotification("Clicca sul PDF per posizionare il testo","info");
}
function undoLastText(){if(textElements.length>0){textElements.pop();renderPage(currentPage);updateTextList();}}
function updateTextList(){const list=document.getElementById("textList"); if(textElements.length===0){list.innerHTML="<p>Nessun testo</p>";return;}
    list.innerHTML=textElements.map(t=>`<div class="text-item"><div>Pag.${t.page}: ${t.text}</div></div>`).join("");}
function previousPage(){if(currentPage>1){currentPage--;renderPage(currentPage);}}
function nextPage(){if(currentPage<totalPages){currentPage++;renderPage(currentPage);}}

// --- Salvataggi completi ---
function getLavori(){return JSON.parse(localStorage.getItem("lavoriPDF"))||{};}
function aggiornaListaLavori(){const lavori=getLavori();const sel=document.getElementById("lavoriList");sel.innerHTML='<option value="">-- Seleziona --</option>';Object.keys(lavori).forEach(n=>{let o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o);});}
function fileToBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(",")[1]);r.onerror=rej;r.readAsDataURL(file);});}
async function salvaLavoro(){
    const nome=document.getElementById("saveName").value.trim(); if(!nome){showNotification("Nome mancante","error");return;}
    const file=document.getElementById("fileInput").files[0]; if(!file){showNotification("Nessun PDF","error");return;}
    const pdfBase64=await fileToBase64(file); const lavori=getLavori();
    lavori[nome]={pdf:pdfBase64,texts:textElements}; localStorage.setItem("lavoriPDF",JSON.stringify(lavori));
    aggiornaListaLavori(); showNotification("Lavoro salvato!","success");
}
async function apriLavoro(){
    const nome=document.getElementById("lavoriList").value; if(!nome)return;
    const lavori=getLavori(); if(!lavori[nome])return;
    const pdfData=Uint8Array.from(atob(lavori[nome].pdf),c=>c.charCodeAt(0));
    currentPDF=await pdfjsLib.getDocument({data:pdfData}).promise; totalPages=currentPDF.numPages; currentPage=1;
    textElements=lavori[nome].texts||[]; renderPage(currentPage); updateTextList();
    document.getElementById("pageControls").style.display="flex"; document.getElementById("addTextBtn").disabled=false;
    showNotification(`Lavoro "${nome}" caricato!`,"success");
}
function cancellaLavoro(){const nome=document.getElementById("saveName").value.trim()||document.getElementById("lavoriList").value;
    if(!nome){showNotification("Seleziona un salvataggio","error");return;}
    const lavori=getLavori(); if(lavori[nome]){delete lavori[nome];localStorage.setItem("lavoriPDF",JSON.stringify(lavori));aggiornaListaLavori();showNotification("Eliminato!","success");}}
document.addEventListener("DOMContentLoaded",aggiornaListaLavori);

// Notifiche
function showNotification(msg,type="info"){const n=document.createElement("div");n.className=`notification ${type}`;n.textContent=msg;document.body.appendChild(n);
    setTimeout(()=>n.classList.add("show"),100);setTimeout(()=>{n.classList.remove("show");setTimeout(()=>n.remove(),300);},3000);}
</script>
</body>
</html>
