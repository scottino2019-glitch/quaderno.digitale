<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Editor Mobile con Supabase</title>
<style>
  body { margin:0; font-family:sans-serif; }
  #toolbar { display:flex; flex-wrap:wrap; gap:5px; padding:5px; background:#333; color:white; }
  button { flex:1; padding:10px; font-size:14px; border:none; border-radius:5px; background:#555; color:white; }
  button.active { background:#28a745; }
  #viewer { position:relative; height:calc(100vh - 60px); overflow:auto; background:#eee; text-align:center; }
  canvas { margin:10px auto; display:block; background:white; }
  .annotation { position:absolute; background:rgba(255,255,0,0.8); padding:2px 4px; border:1px solid #888; font-size:16px; min-width:40px; }
</style>
</head>
<body>

<div id="toolbar">
  <input type="file" id="fileInput" accept="application/pdf">
  <button id="toggleTextBtn">Inserisci testo</button>
  <button id="undoBtn">Annulla</button>
  <button id="saveBtn">Salva</button>
  <button id="closeBtn">Chiudi</button>
</div>

<div id="viewer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.29.0/dist/supabase.min.js"></script>
<script>
/* ====== CONFIGURAZIONE SUPABASE ====== */
const SUPABASE_URL = 'https://TUO_PROJECT.supabase.co';
const SUPABASE_KEY = 'TUO_ANON_KEY';
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====== VARIABILI GLOBALI ====== */
const viewer = document.getElementById('viewer');
const fileInput = document.getElementById('fileInput');
const toggleTextBtn = document.getElementById('toggleTextBtn');
const undoBtn = document.getElementById('undoBtn');
const saveBtn = document.getElementById('saveBtn');
const closeBtn = document.getElementById('closeBtn');

let pdfDoc = null;
let currentFile = null;
let annotations = [];
let insertMode = false;

/* ====== EVENTI ====== */
fileInput.addEventListener('change', async e => {
  const file = e.target.files[0];
  if(!file) return;
  currentFile = file;
  const arrayBuffer = await file.arrayBuffer();
  loadPDF(new Uint8Array(arrayBuffer));
});

toggleTextBtn.onclick = () => {
  insertMode = !insertMode;
  toggleTextBtn.classList.toggle('active', insertMode);
};

undoBtn.onclick = () => {
  annotations.pop();
  renderAnnotations();
};

closeBtn.onclick = () => {
  viewer.innerHTML = '';
  pdfDoc = null;
  annotations = [];
  currentFile = null;
  insertMode = false;
  toggleTextBtn.classList.remove('active');
};

saveBtn.onclick = async () => {
  if(!currentFile) return alert('Nessun PDF aperto!');
  // 1) carica PDF su Supabase
  const { data, error } = await supabase.storage
    .from('pdfs')
    .upload(currentFile.name, currentFile, { upsert: true });
  if(error) return alert('Errore upload PDF: '+error.message);

  // 2) salva annotazioni come JSON
  const annData = new Blob([JSON.stringify(annotations)], {type:'application/json'});
  await supabase.storage.from('pdfs').upload(currentFile.name+'.annotations.json', annData, { upsert:true });
  alert('PDF e annotazioni salvati su Supabase!');
};

/* ====== FUNZIONI PDF ====== */
async function loadPDF(data) {
  pdfDoc = await pdfjsLib.getDocument({data}).promise;
  viewer.innerHTML = '';
  annotations = []; // puliamo annotazioni attuali
  for(let i=1;i<=pdfDoc.numPages;i++){
    const page = await pdfDoc.getPage(i);
    const viewport = page.getViewport({scale:1.5});
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext('2d');
    await page.render({canvasContext: ctx, viewport}).promise;
    canvas.dataset.page = i;
    canvas.addEventListener('click', e => {
      if(!insertMode) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const text = prompt('Inserisci testo:');
      if(!text) return;
      const note = { page: i, x, y, text };
      annotations.push(note);
      renderAnnotations();
    });
    viewer.appendChild(canvas);
  }
}

/* ====== RENDER ANNOTAZIONI ====== */
function renderAnnotations() {
  // rimuovi vecchie
  document.querySelectorAll('.annotation').forEach(a => a.remove());
  annotations.forEach(a => {
    const canvas = document.querySelector(`canvas[data-page="${a.page}"]`);
    if(!canvas) return;
    const noteDiv = document.createElement('div');
    noteDiv.className = 'annotation';
    noteDiv.style.left = a.x+'px';
    noteDiv.style.top = a.y+'px';
    noteDiv.textContent = a.text;
    canvas.parentElement.appendChild(noteDiv);
  });
}
</script>

</body>
</html>
